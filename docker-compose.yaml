services:
  registry:
    image: 'registry:2'
    restart: unless-stopped
    networks:
      - coolify
    volumes:
      - 'registry-data:/var/lib/registry'
    environment:
      REGISTRY_HTTP_SECRET: '${SERVICE_BASE64_REGISTRY}'

  openclaw:
    image: "${OPENCLAW_IMAGE:-ghcr.io/openclaw/openclaw:latest}"
    restart: 'on-failure:10'
    networks:
      - coolify
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    env_file:
      - .env
    environment:
      DOCKER_HOST: 'tcp://docker-proxy:2375'
      OPENCLAW_ENABLE_WEBHOOK_PROXY: '1'
      PORT: 18790
      NODE_ENV: production
      NODE_OPTIONS: '--max-old-space-size=4096'
      HOME: /data
      OPENCLAW_GATEWAY_TOKEN: '${OPENCLAW_GATEWAY_TOKEN:-sk-openclaw-local}'
      OPENCLAW_AGENTS_DEFAULTS_MODEL_FALLBACKS: '${OPENCLAW_AGENTS_DEFAULTS_MODEL_FALLBACKS:-["openrouter/deepseek/deepseek-v3.2","anthropic/claude-3-5-sonnet-20241022"]}'
      OPENCLAW_AGENTS_DEFAULTS_MODEL_PRIMARY: '${OPENCLAW_AGENTS_DEFAULTS_MODEL_PRIMARY:-openrouter/google/gemini-2.5-flash}'
      OPENCLAW_GATEWAY_BIND: '${OPENCLAW_GATEWAY_BIND:-lan}'
      OPENCLAW_GATEWAY_PORT: '${OPENCLAW_GATEWAY_PORT:-18790}'
      OPENCLAW_STATE_DIR: /data/.openclaw
      OPENCLAW_WORKSPACE: /data/openclaw-workspace
      OPENAI_API_KEY: '${OPENAI_API_KEY}'
      ANTHROPIC_API_KEY: '${ANTHROPIC_API_KEY}'
      GEMINI_API_KEY: '${GEMINI_API_KEY}'
      SANDBOX_CONTAINER: '${SANDBOX_CONTAINER:-false}'
      BASE_URL: 'https://${SERVICE_FQDN_OPENCLAW}'
      PUBLIC_URL: 'https://${SERVICE_FQDN_OPENCLAW}'
      OPENCLAW_AUTO_BOOTSTRAP: '1'
      CHOKIDAR_USEPOLLING: 'true'
      OPENCLAW_BETA: '${OPENCLAW_BETA:-false}'
    volumes:
      - 'openclaw-data:/data'
      - 'openclaw-workspace:/root/openclaw-workspace'
    ports:
      - '18790:18790' # Exposed for Cloudflare tunnel access
    depends_on:
      docker-proxy:
        condition: service_healthy
    command:
      - bash
      - /app/scripts/bootstrap.sh
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:18790/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  docker-proxy:
    image: 'tecnativa/docker-socket-proxy:latest'
    restart: unless-stopped
    networks:
      - coolify
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock:ro'
    environment:
      - POST=1
      - CONTAINERS=1
      - IMAGES=1
      - NETWORKS=1
      - INFO=1
      - VERSION=1
      - EXEC=1
      - EVENTS=1
      - BUILD=1 # Required for OpenClaw to build the sandbox
      - PULL=1 # Required to pull the python base image
      - TIMEOUT_CONNECT=5s
      - TIMEOUT_CLIENT=2m
      - TIMEOUT_SERVER=2m
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "2375" ]
      interval: 10s
      timeout: 5s
      retries: 5

  searxng:
    build:
      context: .
      dockerfile: searxng/Dockerfile
    restart: unless-stopped
    networks:
      - coolify
    volumes:
      - 'searxng-data:/var/lib/searxng'
    environment:
      SEARXNG_BASE_URL: 'http://searxng:8080'
      SEARXNG_SERVER_SECRET_KEY: '${SERVICE_BASE64_SEARXNG}'
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

networks:
  coolify:
    external: true

volumes:
  openclaw-data:
  openclaw-workspace:
  searxng-data:
  registry-data:
